<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>五目並べ</title>

<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho&family=Zen+Kurenaido&display=swap" rel="stylesheet">

<style>
body{margin:0;background:#f6f1e7;font-family:"Shippori Mincho",serif}
.app{max-width:560px;margin:auto;padding:10px}
h1{text-align:center;letter-spacing:6px;font-weight:normal}

.controls{text-align:center;margin:6px}
select,button{padding:6px 12px;border-radius:999px;border:1px solid #333}

#status{text-align:center;margin:6px;font-size:14px}

.board-wrap{background:#6b3f1d;padding:14px;border-radius:14px}
.board{position:relative;width:100%;aspect-ratio:1/1}
.grid{
  position:absolute;inset:0;
  background:
  repeating-linear-gradient(to right,transparent 0,transparent calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18)),
  repeating-linear-gradient(to bottom,transparent 0,transparent calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18));
}
.points{position:absolute;inset:0}

.stone{
  position:absolute;width:18px;height:18px;border-radius:50%;
  transform:translate(-50%,-50%) scale(0);
  animation:drop .12s forwards
}
.black{background:radial-gradient(circle at 30% 30%,#555,#000)}
.white{background:radial-gradient(circle at 30% 30%,#fff,#ccc)}
@keyframes drop{to{transform:translate(-50%,-50%) scale(1)}}

.log{
  margin-top:6px;background:#fff;border:2px solid #111;border-radius:10px;
  padding:6px;max-height:200px;overflow:auto;
  font-family:"Zen Kurenaido",sans-serif;font-size:12px
}
.player{color:#1e3a8a}
.cpu{color:#7f1d1d}
.result{font-weight:bold}

.winrate{
  text-align:center;
  font-size:20px;
  margin:6px 0;
}
</style>
</head>

<body>
<div class="app">
<h1>五目並べ</h1>

<div class="controls">
<select id="p1">
<option>人</option>
<option>梅</option>
<option>竹</option>
<option>松</option>
<option>極</option>
<option>鬼</option>
</select>
vs
<select id="p2">
<option>鬼</option>
<option>極</option>
<option>松</option>
<option>竹</option>
<option>梅</option>
<option>人</option>
</select>
<button onclick="startGame()">開始</button>
<button onclick="resetGame()">再戦</button>
</div>

<div class="winrate" id="winrate">勝率 50% → 50%</div>
<div id="status">準備中</div>

<div class="board-wrap">
<div class="board">
<div class="grid"></div>
<div class="points" id="points"></div>
</div>
</div>

<div class="log" id="log"></div>
</div>

<script>
const SIZE=19, step=100/18;
const points=document.getElementById("points");
const logEl=document.getElementById("log");
const statusEl=document.getElementById("status");
const winrateEl=document.getElementById("winrate");

let board,turn,players,gameOver;

for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
  const p=document.createElement("div");
  p.style.position="absolute";
  p.style.left=x*step+"%";
  p.style.top=y*step+"%";
  p.style.width="22px";p.style.height="22px";
  p.style.transform="translate(-50%,-50%)";
  p.onclick=()=>humanMove(x,y);
  points.appendChild(p);
}

function resetGame(){location.reload()}

function startGame(){
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(null));
  points.querySelectorAll(".stone").forEach(s=>s.remove());
  logEl.innerHTML="";
  gameOver=false;
  turn="black";
  players={
    black:document.getElementById("p1").value,
    white:document.getElementById("p2").value
  };
  statusEl.textContent=`${players.black} vs ${players.white}`;
  winrateEl.textContent="勝率 50% → 50%";
  nextTurn();
}

function log(t,c){
  const d=document.createElement("div");
  d.textContent=t;d.className=c;
  logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;
}

function place(x,y,c){
  board[y][x]=c;
  const s=document.createElement("div");
  s.className="stone "+c;
  s.style.left=x*step+"%";s.style.top=y*step+"%";
  points.appendChild(s);
}

function scoreToWinrate(score){
  return Math.round(100/(1+Math.exp(-score/8000)));
}

/* ===== 評価 ===== */
function lineScore(x,y,c){
  let s=0;
  [[1,0],[0,1],[1,1],[1,-1]].forEach(([dx,dy])=>{
    let a=0,b=0,i=1;
    while(board[y+dy*i]?.[x+dx*i]===c){a++;i++}
    i=1;
    while(board[y-dy*i]?.[x-dx*i]===c){b++;i++}
    const n=a+b+1;
    if(n>=5) s+=100000;
    else if(n===4) s+=20000;
    else if(n===3) s+=4000;
    else if(n===2) s+=800;
  });
  return s;
}

function evalBoard(){
  let s=0;
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    if(board[y][x]==="white") s+=lineScore(x,y,"white");
    if(board[y][x]==="black") s-=lineScore(x,y,"black");
  }
  return s;
}

/* ===== CPU ===== */
function getCandidates(){
  const set=new Set();
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    if(board[y][x]){
      for(let dy=-2;dy<=2;dy++)for(let dx=-2;dx<=2;dx++){
        if(board[y+dy]?.[x+dx]===null) set.add((x+dx)+","+(y+dy));
      }
    }
  }
  if(set.size===0) set.add("9,9");
  return [...set].map(s=>s.split(",").map(Number));
}

function cpuMove(level,color){
  let best={s:-Infinity};
  for(const [x,y] of getCandidates()){
    board[y][x]=color;
    let s=evalBoard();
    board[y][x]=null;
    if(s>best.s) best={x,y,s};
  }
  return best;
}

/* ===== 手番 ===== */
function nextTurn(){
  if(gameOver) return;
  const p=players[turn];
  if(p==="人"){
    statusEl.textContent="あなたの手番";
  }else{
    setTimeout(()=>{
      const before=scoreToWinrate(evalBoard());
      const {x,y,s}=cpuMove(p,turn);
      place(x,y,turn);
      const after=scoreToWinrate(evalBoard());
      winrateEl.textContent=`勝率 ${before}% → ${after}%`;
      log(`${p}(${turn})：(${x+1},${y+1})`,"cpu");
      if(checkWin(x,y,turn)) return win(p+"の勝ち");
      turn=turn==="black"?"white":"black";
      nextTurn();
    },150);
  }
}

function humanMove(x,y){
  if(gameOver||players[turn]!=="人"||board[y][x])return;
  const before=scoreToWinrate(evalBoard());
  place(x,y,turn);
  const after=scoreToWinrate(evalBoard());
  winrateEl.textContent=`勝率 ${before}% → ${after}%`;
  log(`あなた：(${x+1},${y+1})`,"player");
  if(checkWin(x,y,turn)) return win("あなたの勝ち");
  turn=turn==="black"?"white":"black";
  nextTurn();
}

function checkWin(x,y,c){
  return [[1,0],[0,1],[1,1],[1,-1]].some(([dx,dy])=>{
    let n=1,i=1;
    while(board[y+dy*i]?.[x+dx*i]===c){n++;i++}
    i=1;
    while(board[y-dy*i]?.[x-dx*i]===c){n++;i++}
    return n>=5;
  });
}

function win(t){
  gameOver=true;
  statusEl.textContent=t;
  log(t,"result");
}
</script>
</body>
</html>
