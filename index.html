<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>五目並べ｜鬼棋士</title>

<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho&family=Zen+Kurenaido&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  background:#f6f1e7;
  font-family:"Shippori Mincho",serif;
}
.app{max-width:560px;margin:auto;padding:10px}
h1{text-align:center;letter-spacing:6px;font-weight:normal}
.controls{text-align:center;margin:6px}
select,button{padding:6px 12px;border-radius:999px;border:1px solid #333}
.board-wrap{background:#6b3f1d;padding:14px;border-radius:14px}
.board{position:relative;width:100%;aspect-ratio:1/1}
.grid{
  position:absolute;inset:0;
  background:
  repeating-linear-gradient(to right,transparent 0,transparent calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18)),
  repeating-linear-gradient(to bottom,transparent 0,transparent calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18 - 1px),rgba(0,0,0,.6) calc(100%/18));
}
.points{position:absolute;inset:0}
.stone{
  position:absolute;width:18px;height:18px;border-radius:50%;
  transform:translate(-50%,-50%) scale(0);
  animation:drop .15s forwards
}
.black{background:radial-gradient(circle at 30% 30%,#555,#000)}
.white{background:radial-gradient(circle at 30% 30%,#fff,#ccc)}
.preview{opacity:.4;transform:translate(-50%,-50%) scale(.85)}
@keyframes drop{to{transform:translate(-50%,-50%) scale(1)}}
.log{
  margin-top:6px;
  background:#fff;border:2px solid #111;border-radius:10px;
  padding:6px;max-height:200px;overflow:auto;
  font-family:"Zen Kurenaido",sans-serif;font-size:12px
}
.player{color:#1e3a8a}
.cpu{color:#7f1d1d}
.result{font-weight:bold}
</style>
</head>

<body>
<div class="app">
<h1>五目並べ</h1>

<div class="controls">
<select id="level">
<option>梅</option>
<option>竹</option>
<option>松</option>
<option>極</option>
<option>鬼</option>
</select>
<button onclick="resetGame()">再戦</button>
</div>

<div id="status" style="text-align:center">あなた（黒）の番｜2回タップ確定</div>

<div class="board-wrap">
<div class="board">
<div class="grid"></div>
<div class="points" id="points"></div>
</div>
</div>

<div class="log" id="log"></div>
</div>

<script>
const SIZE=19;
const step=100/18;
const points=document.getElementById("points");
const logEl=document.getElementById("log");
const statusEl=document.getElementById("status");

let board=[...Array(SIZE)].map(()=>Array(SIZE).fill(null));
let pending=null,gameOver=false;

for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
  const p=document.createElement("div");
  p.style.position="absolute";
  p.style.left=x*step+"%";
  p.style.top=y*step+"%";
  p.style.width="22px";p.style.height="22px";
  p.style.transform="translate(-50%,-50%)";
  p.onclick=()=>tap(x,y);
  points.appendChild(p);
}

function log(t,c){
  const d=document.createElement("div");
  d.textContent=t;d.className=c;
  logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;
}

function rank(s){
  if(s>50000) return "極";
  if(s>8000) return "良";
  if(s>2000) return "普";
  return "微";
}

/* ===== 評価 ===== */
function lineScore(x,y,c){
  let s=0;
  [[1,0],[0,1],[1,1],[1,-1]].forEach(([dx,dy])=>{
    let a=0,b=0,i=1;
    while(board[y+dy*i]?.[x+dx*i]===c){a++;i++}
    i=1;
    while(board[y-dy*i]?.[x-dx*i]===c){b++;i++}
    const n=a+b+1;
    if(n>=5) s+=100000;
    else if(n===4) s+=20000;
    else if(n===3) s+=4000;
    else if(n===2) s+=800;
  });
  return s;
}

function evalAdvanced(x,y,c){
  const e=c==="white"?"black":"white";
  return lineScore(x,y,c)*1.2 + lineScore(x,y,e)*1.6;
}

/* ===== 候補手生成（鬼の要） ===== */
function getCandidates(){
  const set=new Set();
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    if(board[y][x]){
      for(let dy=-2;dy<=2;dy++)for(let dx=-2;dx<=2;dx++){
        const nx=x+dx,ny=y+dy;
        if(board[ny]?.[nx]===null) set.add(nx+","+ny);
      }
    }
  }
  if(set.size===0) set.add("9,9");
  return [...set].map(s=>s.split(",").map(Number));
}

/* ===== αβ探索 ===== */
function alphabeta(depth,alpha,beta,max){
  if(depth===0) return 0;
  const c=max?"white":"black";
  const cand=getCandidates();

  if(max){
    let v=-Infinity;
    for(const [x,y] of cand){
      board[y][x]=c;
      if(checkWin(x,y,c)){board[y][x]=null;return 999999;}
      v=Math.max(v,evalAdvanced(x,y,c)+alphabeta(depth-1,alpha,beta,false));
      board[y][x]=null;
      alpha=Math.max(alpha,v);
      if(beta<=alpha) break;
    }
    return v;
  }else{
    let v=Infinity;
    for(const [x,y] of cand){
      board[y][x]=c;
      if(checkWin(x,y,c)){board[y][x]=null;return -999999;}
      v=Math.min(v,evalAdvanced(x,y,c)+alphabeta(depth-1,alpha,beta,true));
      board[y][x]=null;
      beta=Math.min(beta,v);
      if(beta<=alpha) break;
    }
    return v;
  }
}

/* ===== 操作 ===== */
function tap(x,y){
  if(gameOver||board[y][x])return;
  if(pending&&pending.x===x&&pending.y===y){
    place(x,y,"black");pending=null;
    log(`あなた：(${x+1},${y+1})【${rank(evalAdvanced(x,y,"black"))}】`,"player");
    if(checkWin(x,y,"black"))return win("あなたの勝ち");
    setTimeout(cpuTurn,300);
  }else{
    clearPreview();showPreview(x,y);pending={x,y};
  }
}

function showPreview(x,y){
  const s=document.createElement("div");
  s.id="preview";s.className="stone black preview";
  s.style.left=x*step+"%";s.style.top=y*step+"%";
  points.appendChild(s);
}
function clearPreview(){document.getElementById("preview")?.remove()}

function place(x,y,c){
  clearPreview();board[y][x]=c;
  const s=document.createElement("div");
  s.className="stone "+c;
  s.style.left=x*step+"%";s.style.top=y*step+"%";
  points.appendChild(s);
}

function cpuTurn(){
  const lv=document.getElementById("level").value;
  let best={s:-Infinity};

  for(const [x,y] of getCandidates()){
    let s=0;
    board[y][x]="white";
    if(lv==="梅") s=evalAdvanced(x,y,"white");
    else if(lv==="竹") s=evalAdvanced(x,y,"white")*1.2;
    else if(lv==="松") s=alphabeta(2,-1e9,1e9,false);
    else if(lv==="極") s=alphabeta(4,-1e9,1e9,false);
    else if(lv==="鬼") s=alphabeta(6,-1e9,1e9,false);
    board[y][x]=null;
    if(s>best.s) best={x,y,s};
  }

  place(best.x,best.y,"white");
  log(`CPU【${lv}】：(${best.x+1},${best.y+1})`,"cpu");
  if(checkWin(best.x,best.y,"white")) win("CPUの勝ち");
}

function checkWin(x,y,c){
  return [[1,0],[0,1],[1,1],[1,-1]].some(([dx,dy])=>{
    let n=1,i=1;
    while(board[y+dy*i]?.[x+dx*i]===c){n++;i++}
    i=1;
    while(board[y-dy*i]?.[x-dx*i]===c){n++;i++}
    return n>=5;
  });
}

function win(t){
  gameOver=true;statusEl.textContent=t;log(t,"result");
}

function resetGame(){location.reload()}
</script>
</body>
</html>
